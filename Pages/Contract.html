<!DOCTYPE html>
<html>

<head>
    <title>Data Input</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.js"></script>
    <script src="luxon.min.js"></script>
    <script src="https://js.arcgis.com/4.21/"></script>
    <style>
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        fieldset {
            border: 2px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        legend {
            color: white;
            font-weight: bold;
        }

        html,
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            background-color: #00000000;
            color: rgb(0, 0, 0);
        }



        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .submit-btn {
            display: flex;
            justify-content: center;

        }

        .jumbotron {
            /* backdrop-filter: blur(5px); */
            background: rgba(0, 0, 0, 0.5);
            border: 0px solid #fff;
            color: #00000032;

            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 6px 0px rgba(0, 0, 0, 0.1);
        }

        .jumbotron h2 {
            font-weight: 700;
        }

        .jumbotron p {
            color: #ffffff;
        }

        .white-label label {
            color: white;
        }

        .white-label {
            color: white;
        }

        .submit-btn input {
            background-color: #00904fb1;
            border: 1px solid white;
            /* Adjust border size as per requirement */
            border-radius: 50px;
            /* Adjust radius as per requirement */
            width: 20%;
            font-size: 15px;
            color: white !important;
            margin-top: 5px;
            margin-bottom: 5px;
            /* Adds space between items */
            cursor: pointer;
            transition: all 0.2s ease-out;
        }

        .submit-btn input:hover {
            background-color: #ffffff56;
            transform: scale(1.1);
            /* Image will zoom in slightly when hovered over */
            border: 2px solid #fff;
            /* Add a border on hover */
        }

        .checkbox-container input {
            margin-right: 5px;
        }
    </style>
</head>
<!-- TODO Add perform-bond-type
branding-hammer
road-rock-cy-rqd
file-destray-date
bid opening date
bid type -->

<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="jumbotron text-center mt-4">
                    <form id="dataForm">
                        <fieldset>
                            <legend>Contract Details</legend>
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="ContractTitle"
                                                        name="ContractTitle" required>
                                                    <label for="ContractTitle">Contract Title</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="ContractID"
                                                        name="ContractID" required>
                                                    <label for="ContractID">Contract ID</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="InvitationID"
                                                        name="InvitationID">
                                                    <label for="InvitationID">Invitation ID</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-floating mb-3">
                                                    <textarea class="form-control" id="GeneralSaleDescription"
                                                        name="GeneralSaleDescription" required></textarea>
                                                    <label for="GeneralSaleDescription">General Sale Description</label>
                                                </div>
                                            </div>

                                        </div>
                                        <div class="row">
                                            <!-- First column for Contract Type -->
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" name="ContractType" id="ContractType">
                                                        <option value="Timber">Timber</option>
                                                        <option value="Salvage">Salvage</option>
                                                        <option value="Firewood (Contract)">Firewood (Contract)</option>
                                                        <option value="Construction-Related">Construction-Related
                                                        </option>
                                                        <option value="Training & Range Improvement">Training & Range
                                                            Improvement</option>
                                                        <option value="Ecological/Restoration">Ecological/Restoration
                                                        </option>
                                                        <option value="Wildlife/Habitat Improvement">Wildlife/Habitat
                                                            Improvement</option>
                                                        <option value="Firewood (Permit)">Firewood (Permit)</option>
                                                        <option value="Obstruction Removal">Obstruction Removal</option>
                                                        <option value="WA National Guard">WA National Guard</option>
                                                        <option value="Right of Way Harvest">Right of Way Harvest
                                                        </option>
                                                        <option value="Recreation Enhancement">Recreation Enhancement
                                                        </option>
                                                    </select>
                                                    <label for="ContractType">Contract Type</label>
                                                </div>
                                            </div>
                                            <!-- Second column for Contract Status -->
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" name="SalesContractStatus"
                                                        id="SalesContractStatus">
                                                        <option value="Active-Logging">Active-Logging</option>
                                                        <option value="Active-On Hold">Active-On Hold</option>
                                                        <option value="Closed">Closed</option>
                                                        <option value="Finalizing">Finalizing</option>
                                                        <option value="Pending">Pending</option>
                                                        <option value="Planning">Planning</option>
                                                        <option value="Rescinded">Rescinded</option>
                                                        <option value="Z-Other">Z-Other</option>
                                                    </select>
                                                    <label for="SalesContractStatus">Contract Status</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" name="militaryorcivilcode"
                                                        id="militaryorcivilcode">
                                                        <option value="A">Military</option>
                                                        <option value="W">Civil</option>
                                                    </select>
                                                    <label for="militaryorcivilcode">Military or Civil</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" name="PrimarySpecies"
                                                        id="PrimarySpecies">
                                                        <option value="Alder">Alder</option>
                                                        <option value="Chamarecyparis">Chamarecyparis</option>
                                                        <option value="Cottonwood">Cottonwood</option>
                                                        <option value="Douglas Fir">Douglas Fir</option>
                                                        <option value="Grand Fir">Grand Fir</option>
                                                        <option value="Pacific Madrona">Pacific Madrona</option>
                                                        <option value="Pondarosa Pine">Pondarosa Pine</option>
                                                        <option value="Red Cedar">Red Cedar</option>
                                                        <option value="White Fir">White Fir</option>
                                                        <option value="White Oak">White Oak</option>
                                                        <option value="Woody Biomass">Woody Biomass</option>
                                                    </select>
                                                    <label for="PrimarySpecies">Primary Species</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" name="UnitOfMeasurement"
                                                        id="UnitOfMeasurement">
                                                        <option value="MBF">MBF</option>
                                                        <option value="Cords">Cords</option>
                                                        <option value="Tons">Tons</option>
                                                    </select>
                                                    <label for="UnitOfMeasurement">Unit of Measurement</label>
                                                </div>
                                                
                                            </div>

                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="number" class="form-control" id="ContractAcres"
                                                        name="ContractAcres">
                                                    <label for="ContractAcres">Contract Acres</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="number" class="form-control" name="RoadRockCYRequired"
                                                        id="RoadRockCYRequired">
                                                    <label for="RoadRockCYRequired">Road Rock CY Required</label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- First column for Contract Type -->
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" name="BrandingHammer"
                                                        id="BrandingHammer">
                                                        <option value="A">A</option>
                                                        <option value="B">B</option>
                                                    </select>
                                                    <label for="BrandingHammer">Branding Hammer</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" name="BidType" id="BidType">
                                                        <option value="Scaled">Scaled</option>
                                                        <option value="Lump Sum">Lump Sum</option>
                                                    </select>
                                                    <label for="BidType">Bid Type</label>
                                                </div>
                                            </div>
                                            <!-- Second column for Contract Status -->

                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" id="TimberSalesSpecialist"
                                                        name="TimberSalesSpecialist">
                                                        <!-- Options will be filled by JavaScript -->
                                                    </select>
                                                    <label for="TimberSalesSpecialist">Timber Sales Specialist</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" name="Declared_Supplemental" id="Declared_Supplemental">
                                                        <option value="Declared">Declared</option>
                                                        <option value="Supplemental">Supplemental</option>
                                                    </select>
                                                    <label for="Declared_Supplemental">Declared or Supplemental</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" id="PerformanceBondType"
                                                        name="PerformanceBondType">
                                                        <option value="Not Received">Not Received</option>
                                                        <option value="N/A">N/A</option>
                                                        <option value="Cash/Check/Money Order in FR Safe">Cash/Check/Money Order in FR Safe</option>
                                                        <option value="Assignment of Savings">Assignment of Savings</option>
                                                        <option value="Letter of Credit">Letter of Credit</option>
                                                        <option value="Insurance Bond">Insurance Bond</option>
                                                        <option value="Held in 6501 Suspense Account">Held in 6501 Suspense Account</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                    <label for="PerformanceBondType">Performance Bond Type</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="number"  class="form-control" name="PerformanceBond" id="PerformanceBond">

                                                    <label for="PerformanceBond">Performance Bond</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Contract Dates</legend>
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="date" class="form-control" id="LoggingStartDate"
                                                name="LoggingStartDate">
                                            <label for="LoggingStartDate">Logging Start Date</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="date" class="form-control" id="LoggingEndDate"
                                                name="LoggingEndDate">
                                            <label for="LoggingEndDate">Logging End Date</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <!-- First column for Contract Type -->

                                    <!-- Second column for Contract Status -->
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="date" class="form-control" name="bidOpeningDate"
                                                id="bidOpeningDate">
                                            <label for="bidOpeningDate">Bid Opening Date</label>
                                        </div>
                                    </div>
                                    <!-- Second column for Contract Status -->
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="date" class="form-control" name="FileDestroyDate"
                                                id="FileDestroyDate">
                                            <label for="FileDestroyDate">File Destroy Date</label>
                                        </div>
                                    </div>
                                </div>
                               
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Location</legend>

                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="installation"
                                                        name="installation">
                                                    <label for="installation">Installation</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="TrainingArea"
                                                        name="TrainingArea">
                                                    <label for="TrainingArea">Training Area</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="county" name="county">
                                                    <label for="county">County</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="state" name="state">
                                                    <label for="state">State</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="grid" name="grid">
                                                    <label for="grid">Grid</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="TownshipRangeSection"
                                                        name="TownshipRangeSection">
                                                    <label for="instalTownshipRangeSectionlation">Township Range
                                                        Section</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="Latitude"
                                                        name="Latitude">
                                                    <label for="Latitude">Latitude</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="Longitude"
                                                        name="Longitude">
                                                    <label for="Longitude">Longitude</label>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>




                        <div class="submit-btn">
                            <input type="submit" id="submitButton" value="Submit Edits">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    let featureMap = new Map();
    const urlParams = new URLSearchParams(window.location.search);
    const gid = urlParams.get('gid');
    console.log(gid)
    require([
        "esri/identity/IdentityManager",
        "esri/request",
        "dojo/domReady!"
    ], function (IdentityManager, esriRequest) {


        const signerNamesRequest = esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/6/query", {
            responseType: "json",
            query: {
                where: "isTss='True' AND Active_InactiveSigner = 'True'",
                outFields: "SignerName",
                returnDistinctValues: true,
                f: "json"
            }
        });

        // Get objectid from URL parameters


        const dataFetchRequest = esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/0/query", {
            responseType: "json",
            query: {
                where: `GlobalID='${gid}'`,
                outFields: "*",
                f: "json"
            }
        });

        function formatUnixTimestamp(timestamp) {
            // Create a new Date object
            const date = new Date(timestamp);

            // Extract the date components
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // months are 0-indexed
            const day = date.getDate().toString().padStart(2, '0');

            // Format the date string
            return `${year}-${month}-${day}`;
        }

        Promise.all([ signerNamesRequest, dataFetchRequest])
            .then(function ([ signerNamesResponse, dataFetchResponse]) {
                // Handle the purchaser response
                

                // Handle the signer names response
                const signerNames = signerNamesResponse.data.features.map(feature => feature.attributes.SignerName);
                const selectElement = document.getElementById('TimberSalesSpecialist');
                signerNames.forEach(signerName => {
                    const optionElement = document.createElement('option');
                    optionElement.text = signerName;
                    optionElement.value = signerName;
                    selectElement.add(optionElement);
                });

                // Handle the data fetch response
                const attributes = dataFetchResponse.data.features[0].attributes;
                const changes = {
                    "OBJECTID": attributes["OBJECTID"],
                }; // Initialize an empty object to keep track of changes

                for (const attribute in attributes) {
                    const formField = document.getElementById(attribute);
                    if (formField) {
                        if (formField.type === 'date') {
                            formField.value = formatUnixTimestamp(attributes[attribute]);
                        } else {
                            formField.value = attributes[attribute];
                        }
                    }
                }


                // Add an input event listener to all input fields
                Array.from(document.querySelectorAll('input, select')).forEach((element) => {
                    element.addEventListener('input', function (event) {
                        // Update the changes object when a field changes
                        changes[event.target.id] = event.target.value;
                    });
                });

                // Listen for form submit event
                document.getElementById('dataForm').addEventListener('submit', function (event) {
                    // Prevent the default form submit action
                    event.preventDefault();

                    // Create features array
                    const features = [{
                        "attributes": changes // Use the changes object here
                    }];

                    // Convert features to URL-encoded string
                    const formData = new URLSearchParams();
                    formData.append('f', 'json');
                    formData.append('updates', JSON.stringify(features));

                    // Send a POST request to your REST endpoint
                    esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/0/applyEdits", {
                        method: "post",
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: formData.toString()
                    }).then(function (response) {
                        const success = response.data.updateResults[0];
                        const submitButton = document.getElementById('submitButton');  // Selecting the button

                        if (success) {
                            submitButton.value = 'SUCCESS!';
                        } else {
                            submitButton.value = 'FAILED!';
                        }

                        setTimeout(() => {
                            submitButton.value = 'Submit Edits'; // clear the message after 3 seconds
                        }, 3000);
                    });
                });
            }).catch(error => {
                console.error(error);
                // Optionally: Implement a retry mechanism, alert user, or redirect
            });;
    });
</script>

</html>
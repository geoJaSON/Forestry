<!DOCTYPE html>
<html>

<head>
    <title>Data Input</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.js"></script>
    <script src="luxon.min.js"></script>
    <script src="https://js.arcgis.com/4.21/"></script>
    <style>
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        fieldset {
            border: 2px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        legend {
            color: white;
            font-weight: bold;
        }

        html,
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            background-color: #00000000;
            color: rgb(0, 0, 0);
        }



        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .submit-btn {
            display: flex;
            justify-content: center;

        }

        .jumbotron {
            /* backdrop-filter: blur(5px); */
            background: rgba(0, 0, 0, 0.5);
            border: 0px solid #fff;
            color: #00000032;

            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 6px 0px rgba(0, 0, 0, 0.1);
        }

        .jumbotron h2 {
            font-weight: 700;
        }

        .jumbotron p {
            color: #ffffff;
        }

        .submit-btn input {
            background-color: #00904fb1;
            border: 1px solid white;
            /* Adjust border size as per requirement */
            border-radius: 50px;
            /* Adjust radius as per requirement */
            width: 20%;
            font-size: 15px;
            color: white !important;
            margin-top: 5px;
            margin-bottom: 5px;
            /* Adds space between items */
            cursor: pointer;
            transition: all 0.2s ease-out;
        }

        .submit-btn input:hover {
            background-color: #ffffff56;
            transform: scale(1.1);
            /* Image will zoom in slightly when hovered over */
            border: 2px solid #fff;
            /* Add a border on hover */
        }

        .checkbox-container input {
            margin-right: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="jumbotron text-center mt-4">
                    <form id="dataForm">
                        <fieldset>
                            <legend>Contract Details</legend>
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="ContractTitle"
                                                        name="ContractTitle" required>
                                                    <label for="ContractTitle">Contract Title</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="ContractID"
                                                        name="ContractID" required>
                                                    <label for="ContractID">Contract ID</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="InvitationID"
                                                        name="InvitationID">
                                                    <label for="InvitationID">Invitation ID</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" name="militaryorcivilcode"
                                                        id="militaryorcivilcode">
                                                        <option value="A">Military</option>
                                                        <option value="W">Civil</option>
                                                    </select>
                                                    <label for="militaryorcivilcode">Military or Civil</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" name="PrimarySpecies"
                                                        id="PrimarySpecies">
                                                        <option value="Alder">Alder</option>
                                                        <option value="Chamarecyparis">Chamarecyparis</option>
                                                        <option value="Cottonwood">Cottonwood</option>
                                                        <option value="Douglas Fir">Douglas Fir</option>
                                                        <option value="Grand Fir">Grand Fir</option>
                                                        <option value="Pacific Madrona">Pacific Madrona</option>
                                                        <option value="Pondarosa Pine">Pondarosa Pine</option>
                                                        <option value="Red Cedar">Red Cedar</option>
                                                        <option value="White Fir">White Fir</option>
                                                        <option value="White Oak">White Oak</option>
                                                        <option value="Woody Biomass">Woody Biomass</option>
                                                    </select>
                                                    <label for="PrimarySpecies">Primary Species</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="date" class="form-control" id="LoggingStartDate"
                                                        name="LoggingStartDate" placeholder="Logging Start Date">
                                                    <label for="LoggingStartDate">Logging Start Date</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="date" class="form-control" id="LoggingEndDate"
                                                        name="LoggingEndDate" placeholder="Logging End Date">
                                                    <label for="LoggingEndDate">Logging End Date</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Location Details</legend>

                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="installation"
                                                        name="installation">
                                                    <label for="installation">Installation</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="TrainingArea"
                                                        name="TrainingArea">
                                                    <label for="TrainingArea">Training Area</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="county" name="county">
                                                    <label for="county">County</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="TownshipRangeSection"
                                                        name="TownshipRangeSection">
                                                    <label for="instalTownshipRangeSectionlation">Township Range
                                                        Section</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="Latitude"
                                                        name="Latitude">
                                                    <label for="Latitude">Latitude</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="Longitude"
                                                        name="Longitude">
                                                    <label for="Longitude">Longitude</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="grid" name="grid">
                                                    <label for="grid">Grid</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Contract Type and Status</legend>
                            <div class="container-fluid">
                                <div class="row">
                                    <!-- First column for Contract Type -->
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <select class="form-select" name="ContractType" id="ContractType">
                                                <option value="Timber">Timber</option>
                                                <option value="Salvage">Salvage</option>
                                                <option value="Firewood (Contract)">Firewood (Contract)</option>
                                                <option value="Construction-Related">Construction-Related</option>
                                                <option value="Training & Range Improvement">Training & Range
                                                    Improvement</option>
                                                <option value="Ecological/Restoration">Ecological/Restoration</option>
                                                <option value="Wildlife/Habitat Improvement">Wildlife/Habitat
                                                    Improvement</option>
                                                <option value="Firewood (Permit)">Firewood (Permit)</option>
                                                <option value="Obstruction Removal">Obstruction Removal</option>
                                                <option value="WA National Guard">WA National Guard</option>
                                                <option value="Right of Way Harvest">Right of Way Harvest</option>
                                                <option value="Recreation Enhancement">Recreation Enhancement</option>
                                            </select>
                                            <label for="ContractType">Contract Type</label>
                                        </div>
                                    </div>
                                    <!-- Second column for Contract Status -->
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <select class="form-select" name="SalesContractStatus"
                                                id="SalesContractStatus">
                                                <option value="Active-Logging">Active-Logging</option>
                                                <option value="Active-On Hold">Active-On Hold</option>
                                                <option value="Closed">Closed</option>
                                                <option value="Finalizing">Finalizing</option>
                                                <option value="Pending">Pending</option>
                                                <option value="Planning">Planning</option>
                                                <option value="Rescinded">Rescinded</option>
                                                <option value="Z-Other">Z-Other</option>
                                            </select>
                                            <label for="SalesContractStatus">Contract Status</label>
                                        </div>
                                    </div>
                                </div>
                                <!-- Second row for Declared/Supplemental -->
                                <div class="row justify-content-center">
                                    <div class="col-md-6 text-center">
                                        <div class="form-floating mb-3">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio"
                                                    name="Declared_Supplemental" id="Declared">
                                                <label class="form-check-label" for="Declared">
                                                    Declared
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio"
                                                    name="Declared_Supplemental" id="Supplemental" checked>
                                                <label class="form-check-label" for="Supplemental">
                                                    Supplemental
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>


                        <fieldset>
                            <legend>POC Information</legend>
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" id="TimberSalesSpecialist"
                                                        name="TimberSalesSpecialist">
                                                        <!-- Options will be filled by JavaScript -->
                                                    </select>
                                                    <label for="TimberSalesSpecialist">Timber Sales Specialist</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <select class="form-select" id="purchaser" name="purchaser">
                                                        <!-- Options will be filled by JavaScript -->
                                                    </select>
                                                    <label for="purchaser">Purchaser</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="PurchaserPOC"
                                                        name="PurchaserPOC"">
                                                    <label for="PurchaserPOC">Purchaser POC</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="PurchaserPOCPhone"
                                                        name="PurchaserPOCPhone"">
                                                    <label for="PurchaserPOCPhone">Purchaser POC Phone</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating mb-3">
                                                    <input type="text" class="form-control" id="PurchaserPOCEmail"
                                                        name="PurchaserPOCEmail"">
                                                    <label for="PurchaserPOCEmail">Purchaser POC Email</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-floating mb-3">
                                                    <select id="logger" class="form-select" name="logger">
                                                        <!-- Options will be filled by JavaScript -->
                                                    </select>
                                                    <label for="logger">Logger</label>







                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6"><label>Unit of Measurement</label>
                                                <div>
                                                    <input type="radio" id="Cords" name="UnitOfMeasurement"
                                                        value="Cords">
                                                    <label for="Cords">Cords</label>

                                                    <input type="radio" id="MBF" name="UnitOfMeasurement" value="MBF">
                                                    <label for="MBF">MBF</label>

                                                    <input type="radio" id="Tons" name="UnitOfMeasurement" value="Tons">
                                                    <label for="Tons">Tons</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6"><input type="number" class="form-control"
                                                    id="ContractAcres" name="ContractAcres"
                                                    placeholder="Contract Acres">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <div class="submit-btn">
                            <input type="submit" id="submitButton" value="Submit Edits">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    let featureMap = new Map();
    const urlParams = new URLSearchParams(window.location.search);
    const gid = urlParams.get('gid');
    console.log(gid)
    require([
        "esri/identity/IdentityManager",
        "esri/request",
        "dojo/domReady!"
    ], function (IdentityManager, esriRequest) {
        const purchaserRequest = esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/2/query", {
            responseType: "json",
            query: {
                where: "Purchaser='True'",
                outFields: "ContactBusinessName, ContactFirstName, ContactLastName, ContactPhone, ContactEMail1",
                f: "json"
            }
        });

        const signerNamesRequest = esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/6/query", {
            responseType: "json",
            query: {
                where: "isTss='True'",
                outFields: "SignerName",
                returnDistinctValues: true,
                f: "json"
            }
        });

        // Get objectid from URL parameters


        const dataFetchRequest = esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/0/query", {
            responseType: "json",
            query: {
                where: `GlobalID='${gid}'`,
                outFields: "*",
                f: "json"
            }
        });

        function formatUnixTimestamp(timestamp) {
            // Create a new Date object
            const date = new Date(timestamp);

            // Extract the date components
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // months are 0-indexed
            const day = date.getDate().toString().padStart(2, '0');

            // Format the date string
            return `${year}-${month}-${day}`;
        }

        Promise.all([purchaserRequest, signerNamesRequest, dataFetchRequest])
            .then(function ([purchaserResponse, signerNamesResponse, dataFetchResponse]) {
                // Handle the purchaser response
                const purchaserSelect = document.getElementById('purchaser');
                const loggerSelect = document.getElementById('logger');

                purchaserSelect.innerHTML = '';
                loggerSelect.innerHTML = '';

                const sortedFeatures = purchaserResponse.data.features.sort((a, b) => {
                    if (a.attributes.ContactBusinessName < b.attributes.ContactBusinessName) return -1;
                    if (a.attributes.ContactBusinessName > b.attributes.ContactBusinessName) return 1;
                    return 0;
                });

                sortedFeatures.forEach(feature => {
                    const option = document.createElement('option');
                    option.value = feature.attributes.ContactBusinessName;
                    option.textContent = feature.attributes.ContactBusinessName;
                    featureMap.set(option.value, feature);
                    purchaserSelect.appendChild(option);
                });

                sortedFeatures.forEach(feature => {
                    const option = document.createElement('option');
                    option.value = feature.attributes.ContactBusinessName;
                    option.textContent = feature.attributes.ContactBusinessName;
                    featureMap.set(option.value, feature);
                    loggerSelect.appendChild(option);
                });

                // Handle the signer names response
                const signerNames = signerNamesResponse.data.features.map(feature => feature.attributes.SignerName);
                const selectElement = document.getElementById('TimberSalesSpecialist');
                signerNames.forEach(signerName => {
                    const optionElement = document.createElement('option');
                    optionElement.text = signerName;
                    optionElement.value = signerName;
                    selectElement.add(optionElement);
                });

                // Handle the data fetch response
                const attributes = dataFetchResponse.data.features[0].attributes;
                const changes = {
                    "OBJECTID": attributes["OBJECTID"],
                }; // Initialize an empty object to keep track of changes

                for (const attribute in attributes) {
                    const formField = document.getElementById(attribute);
                    if (formField) {
                        if (formField.type === 'date') {
                            formField.value = formatUnixTimestamp(attributes[attribute]);
                        } else {
                            formField.value = attributes[attribute];
                        }
                    }
                }
                document.getElementById('purchaser').addEventListener('change', function (e) {
                    // Get the feature from the map using the selected value
                    const selectedFeature = featureMap.get(e.target.value);

                    if (selectedFeature) {
                        selectedPOC = selectedFeature.attributes.ContactFirstName + ' ' + selectedFeature.attributes.ContactLastName;
                        document.getElementById('PurchaserPOC').value = selectedPOC;
                        console.log('Selected POC:', selectedPOC);

                        selectedPhone = selectedFeature.attributes.ContactPhone;
                        document.getElementById('PurchaserPOCPhone').value = selectedPhone;
                        console.log('Selected Phone:', selectedPhone);

                        selectedEmail = selectedFeature.attributes.ContactEMail1;
                        document.getElementById('PurchaserPOCEmail').value = selectedEmail;
                        console.log('Selected Email:', selectedEmail);
                    }
                });
                // Convert the select box into a searchable select box with Select2
                $(purchaserSelect).select2({
                    width: 'resolve' // need to override the changed width by Select2
                }).on('select2:select', function (e) {
                    // Get the feature from the map using the selected value
                    const selectedFeature = featureMap.get(e.target.value);

                    if (selectedFeature) {
                        selectedPOC = selectedFeature.attributes.ContactFirstName + ' ' + selectedFeature.attributes.ContactLastName;
                        document.getElementById('PurchaserPOC').value = selectedPOC;
                        console.log('Selected POC:', selectedPOC);

                        selectedPhone = selectedFeature.attributes.ContactPhone;
                        document.getElementById('PurchaserPOCPhone').value = selectedPhone;
                        console.log('Selected Phone:', selectedPhone);

                        selectedEmail = selectedFeature.attributes.ContactEMail1;
                        document.getElementById('PurchaserPOCEmail').value = selectedEmail;
                        console.log('Selected Email:', selectedEmail);
                    }
                });

                // Add an input event listener to all input fields
                Array.from(document.querySelectorAll('input, select')).forEach((element) => {
                    element.addEventListener('input', function (event) {
                        // Update the changes object when a field changes
                        changes[event.target.id] = event.target.value;
                    });
                });

                // Listen for form submit event
                document.getElementById('dataForm').addEventListener('submit', function (event) {
                    // Prevent the default form submit action
                    event.preventDefault();

                    // Create features array
                    const features = [{
                        "attributes": changes // Use the changes object here
                    }];

                    // Convert features to URL-encoded string
                    const formData = new URLSearchParams();
                    formData.append('f', 'json');
                    formData.append('updates', JSON.stringify(features));

                    // Send a POST request to your REST endpoint
                    esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/0/applyEdits", {
                        method: "post",
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: formData.toString()
                    }).then(function (response) {
                        const success = response.data.updateResults[0];
                        const submitButton = document.getElementById('submitButton');  // Selecting the button

                        if (success) {
                            submitButton.value = 'SUCCESS!';
                        } else {
                            submitButton.value = 'FAILED!';
                        }

                        setTimeout(() => {
                            submitButton.value = 'Submit Edits'; // clear the message after 3 seconds
                        }, 3000);
                    });
                });
            }).catch(error => {
                console.error(error);
                // Optionally: Implement a retry mechanism, alert user, or redirect
            });;
    });
</script>

</html>
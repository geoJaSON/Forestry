<!DOCTYPE html>
<html>

<head>
    <title>Data Input</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://js.arcgis.com/4.21/"></script>
    <style>
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        .submit-btn {
            display: flex;
            justify-content: center;
        }

        html,
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            background-color: #00000000;
            color: rgb(0, 0, 0);
        }

        .jumbotron {
            background-color: #ffffff2d;
            border: 0px solid #fff;
            color: #ffffff;

            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 6px 0px rgba(0, 0, 0, 0.1);
        }

        .jumbotron h2 {
            font-weight: 700;
        }

        .jumbotron p {
            color: #ffffff;
        }

        fieldset {
            border: 2px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        legend {
            color: white;
            font-weight: bold;
        }

        .pdf-btn {
            background-color: #00904fb1;
            border: 1px solid white;
            /* Adjust border size as per requirement */
            border-radius: 50px;
            /* Adjust radius as per requirement */
            /* width: 20%; */
            font-size: 11px;
            color: white !important;
            margin-top: 5px;
            margin-bottom: 5px;
            /* Adds space between items */
            cursor: pointer;
            transition: all 0.2s ease-out;
        }

        .submit-btn input {
            background-color: #00904fb1;
            border: 1px solid white;
            /* Adjust border size as per requirement */
            border-radius: 50px;
            /* Adjust radius as per requirement */
            width: 30%;
            font-size: 15px;
            color: white !important;
            margin-top: 5px;
            margin-bottom: 5px;
            /* Adds space between items */
            cursor: pointer;
            transition: all 0.2s ease-out;
        }

        .pdf-btn:hover {
            background-color: #ffffff56;
            transform: scale(1.1);
            /* Image will zoom in slightly when hovered over */
            border: 2px solid #fff;
        }

        .submit-btn input:hover {
            background-color: #ffffff56;
            transform: scale(1.1);
            /* Image will zoom in slightly when hovered over */
            border: 2px solid #fff;
            /* Add a border on hover */
        }


        .button-container {
            display: flex;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="jumbotron text-center mt-4">
                    <form id="dataForm">
                        <fieldset>
                            <legend>Contract Details</legend>
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <select id="TimberSalesSpecialist" name="TimberSalesSpecialist" class="form-control">
                                                    <!-- Options will be filled by JavaScript -->
                                                </select>
                                                <label for="TimberSalesSpecialist" class="label-floating">Timber Sales
                                                    Specialist</label>
                                            </div>
                                            </div>
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <select id="AwardCoverLetterSigner" name="AwardCoverLetterSigner" class="form-control">
                                                    <!-- Options will be filled by JavaScript -->
                                                </select>
                                                <label for="AwardCoverLetterSigner" class="label-floating">Contract
                                                    Signer</label>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            
                            <div class="form-floating mb-3">
                                <textarea id="SalePurpose" name="SalePurpose" class="form-control"></textarea>
                                <label for="SalePurpose" class="label-floating">Sale Purpose</label>
                            </div>
                            <div class="form-floating mb-3">
                                <textarea id="GeneralSaleDescription" name="GeneralSaleDescription"
                                    class="form-control"></textarea>
                                <label for="GeneralSaleDescription" class="label-floating">General Sale
                                    Description</label>
                            </div>
                            <div class="form-floating mb-3">
                                <textarea id="UniqueConditions" name="UniqueConditions" rows="3"
                                    class="form-control"></textarea>
                                <label for="UniqueConditions" class="label-floating">Unique Conditions</label>
                            </div>
                            <div class="form-floating mb-3">
                                <textarea id="AwardOF41Notes" name="AwardOF41Notes" class="form-control"></textarea>
                                <label for="AwardOF41Notes" class="label-floating">Award OF41 Notes</label>
                            </div>

                        </fieldset>

                        <fieldset>
                            <legend>Awarded Purchaser</legend>


                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <select id="purchaser" name="purchaser" class="form-control">
                                                    <!-- Options will be filled by JavaScript -->
                                                </select>
                                                <label for="purchaser" class="label-floating">Purchaser</label>
                                            </div>
                                            </div>
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="text" id="PurchaserPOC" name="PurchaserPOC" class="form-control">
                                                <label for="PurchaserPOC" class="label-floating">Purchaser POC</label>
                                            </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="text" id="PurchaserPOCPhone" name="PurchaserPOCPhone" class="form-control">
                                                <label for="PurchaserPOCPhone" class="label-floating">Purchaser POC Phone</label>
                                            </div>
                                            </div>
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="text" id="PurchaserPOCEmail" name="PurchaserPOCEmail" class="form-control">
                                                <label for="PurchaserPOCEmail" class="label-floating">Purchaser POC Email</label>
                                            </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="text" id="PurchaserPOCAddress" name="PurchaserPOCAddress"
                                                    class="form-control">
                                                <label for="PurchaserPOCAddress" class="label-floating">Purchaser POC
                                                    Address</label>
                                            </div>
                                            </div>
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="text" id="PurchaserPOCCity" name="PurchaserPOCCity" class="form-control">
                                                <label for="PurchaserPOCCity" class="label-floating">Purchaser POC City</label>
                                            </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="text" id="PurchaserPOCZip" name="PurchaserPOCZip" class="form-control">
                                                <label for="PurchaserPOCZip" class="label-floating">Purchaser POC Zip</label>
                                            </div>
                                            </div>
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="text" id="PurchaserFedTaxID" name="PurchaserFedTaxID" class="form-control">
                                                <label for="PurchaserFedTaxID" class="label-floating">Purchaser Fed Tax ID</label>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend>Bid Information</legend>

                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="number" id="ScaledUnitPrice" name="ScaledUnitPrice"
                                                    placeholder="Scaled Unit Price" class="form-control">
                                                <label for="ScaledUnitPrice" class="label-floating">Scaled Unit Price</label>
                                            </div>
                                            </div>
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="number" id="BidDeposit" name="BidDeposit" placeholder="Bid Deposit"
                                                    class="form-control">
                                                <label for="BidDeposit" class="label-floating">Bid Deposit</label>
                                            </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="number" id="WinningBid" name="WinningBid" placeholder="Winning Bid"
                                                    class="form-control">
                                                <label for="WinningBid" class="label-floating">Winning Bid</label>
                                            </div>
                                            </div>
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="number" id="PerformanceBond" name="PerformanceBond"
                                                    placeholder="Performance Bond" class="form-control">
                                                <label for="PerformanceBond" class="label-floating">Performance Bond</label>
                                            </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="date" id="IntentToAwardDate" name="IntentToAwardDate" class="form-control">
                                                <label for="IntentToAwardDate" class="label-floating">Intent to Award Date</label>
                                            </div>
                                            </div>
                                            <div class="col-md-6"><div class="form-floating mb-3">
                                                <input type="date" id="ContractSignDate" name="ContractSignDate" class="form-control">
                                                <label for="ContractSignDate" class="label-floating">Contract Sign Date</label>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <div class="submit-btn">
                            <input type="submit" value="Submit">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

<script>
    let featureMap = new Map();
    const urlParams = new URLSearchParams(window.location.search);
    const cid = urlParams.get('cid');
    const pgid = urlParams.get('gid');
    require([
        "esri/identity/IdentityManager",
        "esri/request",
        "dojo/domReady!"
    ], function (IdentityManager, esriRequest) {
        const purchaserRequest = esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/8/query", {
            responseType: "json",
            query: {
                where: "parentglobalid='" + pgid + "'",
                outFields: "biddername, bidderphone, bidderemail, bidderaddress, biddercity, bidderzip, unitbid, biddeposit, totaloffer",
                f: "json"
            }
        });

        const signerNamesRequest = esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/6/query", {
            responseType: "json",
            query: {
                where: "1=1",
                outFields: "SignerName",
                returnDistinctValues: true,
                f: "json"
            }
        });



        const dataFetchRequest = esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/0/query", {
            responseType: "json",
            query: {
                where: `GlobalID='${pgid}'`,
                outFields: "*",
                f: "json"
            }
        });

        function formatUnixTimestamp(timestamp) {
            // Create a new Date object
            const date = new Date(timestamp);

            // Extract the date components
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // months are 0-indexed
            const day = date.getDate().toString().padStart(2, '0');

            // Format the date string
            return `${year}-${month}-${day}`;
        }
        Promise.all([purchaserRequest, signerNamesRequest, dataFetchRequest])
            .then(function ([purchaserResponse, signerNamesResponse, dataFetchResponse]) {
                // Handle the purchaser response
                const purchaserSelect = document.getElementById('purchaser');

                purchaserSelect.innerHTML = ' ';

                const sortedFeatures = purchaserResponse.data.features.sort((a, b) => {
                    if (a.attributes.biddername < b.attributes.biddername) return -1;
                    if (a.attributes.biddername > b.attributes.biddername) return 1;
                    return 0;
                });

                sortedFeatures.forEach(feature => {
                    const option = document.createElement('option');
                    option.value = feature.attributes.biddername;
                    option.textContent = feature.attributes.biddername;
                    featureMap.set(option.value, feature);
                    purchaserSelect.appendChild(option);
                });



                // Handle the signer names response
                const signerNames = signerNamesResponse.data.features.map(feature => feature.attributes.SignerName);
                const tssElement = document.getElementById('TimberSalesSpecialist');
                const signElement = document.getElementById('AwardCoverLetterSigner');

                signerNames.forEach(signerName => {
                    // Create option element for TimberSalesSpecialist select list
                    const tssOptionElement = document.createElement('option');
                    tssOptionElement.text = signerName;
                    tssOptionElement.value = signerName;
                    tssElement.add(tssOptionElement);

                    // Create option element for AwardCoverLetterSigner select list
                    const signOptionElement = document.createElement('option');
                    signOptionElement.text = signerName;
                    signOptionElement.value = signerName;
                    signElement.add(signOptionElement);
                });


                // Handle the data fetch response
                const attributes = dataFetchResponse.data.features[0].attributes;
                const changes = {
                    "OBJECTID": attributes["OBJECTID"],
                }; // Initialize an empty object to keep track of changes

                for (const attribute in attributes) {
                    const formField = document.getElementById(attribute);
                    if (formField) {
                        if (formField.type === 'date') {
                            formField.value = formatUnixTimestamp(attributes[attribute]);
                        } else {
                            formField.value = attributes[attribute];
                        }
                    }
                }
                document.getElementById('purchaser').addEventListener('change', function (e) {
                    // Get the feature from the map using the selected value
                    const selectedFeature = featureMap.get(e.target.value);

                    if (selectedFeature) {
                        selectedPOC = selectedFeature.attributes.bidderpoc;
                        document.getElementById('PurchaserPOC').value = selectedPOC;

                        selectedPhone = selectedFeature.attributes.bidderphone;
                        document.getElementById('PurchaserPOCPhone').value = selectedPhone;

                        selectedEmail = selectedFeature.attributes.bidderemail;
                        document.getElementById('PurchaserPOCEmail').value = selectedEmail;

                        selectedBid = selectedFeature.attributes.totaloffer;
                        document.getElementById('WinningBid').value = selectedBid;

                        selectedDeposit = selectedFeature.attributes.biddeposit;
                        document.getElementById('BidDeposit').value = selectedDeposit;

                        selectedAddress = selectedFeature.attributes.bidderaddress;
                        document.getElementById('PurchaserPOCAddress').value = selectedAddress;

                        selectedCity = selectedFeature.attributes.biddercity;
                        document.getElementById('PurchaserPOCCity').value = selectedBid;

                        selectedZip = selectedFeature.attributes.bidderzip;
                        document.getElementById('PurchaserPOCZip').value = selectedDeposit;
                    }
                });
                // Convert the select box into a searchable select box with Select2
                $(purchaserSelect).select2({
                    width: 'resolve' // need to override the changed width by Select2
                }).on('select2:select', function (e) {
                    // Get the feature from the map using the selected value
                    const selectedFeature = featureMap.get(e.target.value);

                    if (selectedFeature) {
                        selectedPOC = selectedFeature.attributes.bidderpoc;
                        document.getElementById('PurchaserPOC').value = selectedPOC;

                        selectedPhone = selectedFeature.attributes.bidderphone;
                        document.getElementById('PurchaserPOCPhone').value = selectedPhone;

                        selectedEmail = selectedFeature.attributes.bidderemail;
                        document.getElementById('PurchaserPOCEmail').value = selectedEmail;

                        selectedBid = selectedFeature.attributes.totaloffer;
                        document.getElementById('WinningBid').value = selectedBid;

                        selectedDeposit = selectedFeature.attributes.biddeposit;
                        document.getElementById('BidDeposit').value = selectedDeposit;

                        selectedAddress = selectedFeature.attributes.bidderaddress;
                        document.getElementById('PurchaserPOCAddress').value = selectedAddress;

                        selectedCity = selectedFeature.attributes.biddercity;
                        document.getElementById('PurchaserPOCCity').value = selectedBid;

                        selectedZip = selectedFeature.attributes.bidderzip;
                        document.getElementById('PurchaserPOCZip').value = selectedDeposit;
                    }
                });

                // Add an input event listener to all input fields
                Array.from(document.querySelectorAll('input, select')).forEach((element) => {
                    element.addEventListener('input', function (event) {
                        // Update the changes object when a field changes
                        changes[event.target.id] = event.target.value;
                    });
                });

                // Listen for form submit event
                document.getElementById('dataForm').addEventListener('submit', function (event) {
                    // Prevent the default form submit action
                    event.preventDefault();

                    // Create features array
                    const features = [{
                        "attributes": changes // Use the changes object here
                    }];

                    // Convert features to URL-encoded string
                    const formData = new URLSearchParams();
                    formData.append('f', 'json');
                    formData.append('updates', JSON.stringify(features));

                    // Send a POST request to your REST endpoint
                    esriRequest("https://arcportal-ucop-corps.usace.army.mil/s0arcgis/rest/services/Forestry/FeatureServer/0/applyEdits", {
                        method: "post",
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: formData.toString()
                    }).then(function (response) {
                        console.log(response.data);
                    }).catch(function (error) {
                        console.error(error);
                    });
                });
            });
    });
</script>




</html>